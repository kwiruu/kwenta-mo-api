// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User profile (linked to Supabase Auth)
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  business    Business?
  ingredients Ingredient[]
  recipes     Recipe[]
  sales       Sale[]
  expenses    Expense[]

  @@map("users")
}

// Business profile
model Business {
  id                String   @id @default(uuid())
  userId            String   @unique @map("user_id")
  businessName      String   @map("business_name")
  businessType      String?  @map("business_type")
  address           String?
  employeeCount     Int?     @map("employee_count")
  avgMonthlySales   Decimal? @map("avg_monthly_sales") @db.Decimal(12, 2)
  rawMaterialSource String?  @map("raw_material_source")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("businesses")
}

// Ingredients
model Ingredient {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  name         String
  category     String?
  unit         String   // e.g., kg, L, pcs
  costPerUnit  Decimal  @map("cost_per_unit") @db.Decimal(10, 2)
  currentStock Decimal  @default(0) @map("current_stock") @db.Decimal(10, 3)
  reorderLevel Decimal  @default(0) @map("reorder_level") @db.Decimal(10, 3)
  supplier     String?
  notes        String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipeIngredients RecipeIngredient[]

  @@map("ingredients")
}

// Recipes
model Recipe {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  name          String
  description   String?
  category      String?
  servings      Int      @default(1)
  sellingPrice  Decimal  @map("selling_price") @db.Decimal(10, 2)
  laborCost     Decimal  @default(0) @map("labor_cost") @db.Decimal(10, 2)
  overheadCost  Decimal  @default(0) @map("overhead_cost") @db.Decimal(10, 2)
  imageUrl      String?  @map("image_url")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  ingredients RecipeIngredient[]
  sales       Sale[]

  @@map("recipes")
}

// Recipe Ingredients (junction table)
model RecipeIngredient {
  id           String  @id @default(uuid())
  recipeId     String  @map("recipe_id")
  ingredientId String  @map("ingredient_id")
  quantity     Decimal @db.Decimal(10, 3)
  unit         String  // Unit for this recipe (may differ from ingredient's base unit)
  notes        String?

  // Relations
  recipe     Recipe     @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  ingredient Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  @@unique([recipeId, ingredientId])
  @@map("recipe_ingredients")
}

// Sales
model Sale {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  recipeId    String   @map("recipe_id")
  quantity    Int
  unitPrice   Decimal  @map("unit_price") @db.Decimal(10, 2)
  totalPrice  Decimal  @map("total_price") @db.Decimal(10, 2)
  costOfGoods Decimal  @map("cost_of_goods") @db.Decimal(10, 2)
  profit      Decimal  @db.Decimal(10, 2)
  saleDate    DateTime @map("sale_date")
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@map("sales")
}

// Expenses
model Expense {
  id          String        @id @default(uuid())
  userId      String        @map("user_id")
  category    ExpenseCategory
  description String
  amount      Decimal       @db.Decimal(10, 2)
  expenseDate DateTime      @map("expense_date")
  receiptUrl  String?       @map("receipt_url")
  notes       String?
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("expenses")
}

enum ExpenseCategory {
  INGREDIENTS
  LABOR
  UTILITIES
  RENT
  EQUIPMENT
  MARKETING
  TRANSPORTATION
  PACKAGING
  OTHER
}
